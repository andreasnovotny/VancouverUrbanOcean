---
title: "R Notebook"
output: html_notebook
---

```{r}

### SERVER: DATA PREPARATIONS AND FUNCTIONS ##### 

# Specify libraries
library(plotly)
library(ggpubr)
library(paletteer)
library(viridis)
library(cowplot)
library(leaflet)
library(readxl)
library(tidyverse)
library(vegan)
library(broom)
library(car)
library(indicspecies)
source("Code/Functions.R")


### 1. READ IN DATA  #####

# Sequence data all
Species_table2023 <- read_csv("Data_import/Loic/12S_species_table.csv")

# Metadata from the urban oceans project
Metadata_UO <- read_excel("Data_import/Loic/VeDNA_UrbanOcean2023_sampledata.xlsx", 
    col_types = c("text", "text", "text", 
        "date", "text", "text", "numeric", 
        "numeric", "numeric", "numeric", "text", 
        "text", "text", "numeric", "date", 
        "text", "text", "text", "numeric", 
        "text", "text", "text", "text", "numeric", 
        "text", "text", "text")) %>% 
  select(Sample_ID, Event_ID, Type, Sample_Date, Station_ID, Location,
         Line_out_depth, Bottom_depth, Latitude, Longitude)

# Metadata from the Fjords project
Metadata_Fjords <- read_csv("Data_import/Loic/01_Metadata_all.csv", 
  col_types = cols(Year = col_number())) %>% 
  filter(Survey == "FJORDS_BIODIVERSITY") %>% 
  transmute(Sample_ID = Hakai.ID,
            Event_ID = "Fjords",
            Type = "Fjords",
            Sample_Date = Date,
            Station_ID = Site_ID,
            Location = Location.ID,
            Line_out_depth = as.double(Depth),
            Bottom_depth = CTD_depth,
            Latitude = Lat,
            Longitude = Long
            )
# Merge the two metadata sets
Metadata2023 <- bind_rows(Metadata_UO, Metadata_Fjords)

# Merge metadata with sequence data
sp <- Species_table2023 %>% 
  select(!1) %>% 
  pivot_longer(!1:2, names_to = "Sample_ID", values_to = "Abundance")

All_12S_2023 <- Metadata2023 %>% 
  left_join(sp, by = "Sample_ID")


#### 2. DATA MODIFICATIONS ######

# Remove samples with low counts
Good_OU_12S <- All_12S_2023 %>% 
  group_by(Sample_ID) %>%
  filter(sum(Abundance)>10000) %>% 
  ungroup() %>% 
  
  filter(Line_out_depth == 0) %>%
  filter(Type != "FieldBlank") %>% 
  filter(month(Sample_Date) != 1)


# Calculate eDNA index for all samples and species
Indexed_UO_12S <- Good_OU_12S %>% 
  index_RA(sample = Sample_ID,
           taxa = scientificName,
           abundance = Abundance,
           Sample_Date, Station_ID, Location, Line_out_depth,
           Bottom_depth, Latitude, Longitude, Type)


# Rank species based on their mean relative sequence abundance, and filter low occuring species
Rank <- Indexed_UO_12S %>% 
  group_by(scientificName) %>% 
  summarise(RA = mean(RA)) %>% 
  arrange(-RA) %>% 
  filter(RA > 0.0000)

Indexed_UO_12S <- Indexed_UO_12S %>% 
  filter(scientificName %in% Rank$scientificName)

# Read in a scientific to common name translation
common_names <- read_excel("Data_output/Common_names.xlsx")

# Specify an order of sampling locations:
location_order <- c(
  "Rivers",
  "Bute",
  "Toba",
  "Howe_Sound",
  "Outer Harbour",
  "False Creek",
  "Inner Harbour",
  "Central Harbour",
  "Port Moody Arm",
  "Indian"
  )

location_names <- c(
  "Rivers Inlet",
  "Bute Inlet",
  "Toba Inlet",
  "Howe Sound",
  "Outer Harbour",
  "False Creek",
  "Inner Harbour",
  "Central Harbour",
  "Port Moody Arm",
  "Indian Arm"
  )

# Make four sampling season categories
Indexed_UO_12S <- Indexed_UO_12S %>% 
  mutate(
    Month =
      ifelse(month(Sample_Date) == 2, "Feb/Mar",
             ifelse(month(Sample_Date) == 3, "Feb/Mar",
                    ifelse(month(Sample_Date) == 5, "May",
                           ifelse(month(Sample_Date) == 8, "Aug",
                                  ifelse(month(Sample_Date) == 8, "Aug",
                                         ifelse(month(Sample_Date) == 11, "Nov",
                                                "else"))))))) %>% 
  mutate(Location = factor(Location, levels = location_order, labels = location_names))



Indexed_UO_12S <- Indexed_UO_12S %>% 
  mutate(Taxa = scientificName) %>% 
  left_join(common_names, by = "Taxa") %>% 
  filter(Fish == "Fish")








# Make list of unique Species names
all_species <- Indexed_UO_12S %>% 
  pull(Name) %>%  unique()


### PLOTTING FUNCTIONS ###

# 1. Map function
plotMat <- function(taxa, month, location) {
  
  mapplot = Indexed_UO_12S %>%
    group_by(Location, Station_ID, Month, Name) %>%
   summarise(RA_Index = mean(RA_Index),
            RA = mean(RA),
            Seq.abundance = sum(Abundance),
            Longitude, Latitude) %>%
  mutate(Popup = paste(Station_ID, "<br/>",
                       "eDNA Index: ", round(RA_Index, digits = 3), "<br/>",
                       "Relative Abundance: ", round(RA, digits = 3), "<br/>",
                       "Number of sequences: ", Seq.abundance)) %>% 
  
  filter(Name == taxa,
         Month == month) %>%
  leaflet() %>%
  addTiles() %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>%
  #setView(-123.1, 49.30, zoom = 11) %>% 
  addCircles(~Longitude, ~Latitude, popup = ~Popup,
             weight = ~RA_Index*75, color = "red")
  

  if (location == "Vancouver") {
    m <- mapplot %>%
      setView(-123.1, 49.30, zoom = 11)
    }
  if (location == "Lower Mainland") {
    m <- mapplot %>%
      setView(-123.1, 49.45, zoom = 9)
    }
  if (location == "British Columbia") {
    m <- mapplot %>%
      setView(-125.1, 49.90, zoom = 6)
  }
  
  return(m)

}





### END OF SERVER SCRIPT ####
```



```{r}
Location_color <- c(
  "Rivers Inlet" ='#c7eae5',
  "Bute Inlet" = '#80cdc1',
  "Toba Inlet" = '#35978f',
  "Howe Sound" = '#01665e',
  "Outer Harbour" = '#f6e8c3',
  "False Creek" = '#dfc27d',
  "Inner Harbour" = '#bf812d',
  "Central Harbour" = '#8c510a',
  "Port Moody Arm" = '#543005',
  "Indian Arm" = '#003c30'
)

Urban <- c(
  "Outer Harbour",
  "False Creek",
  "Inner Harbour",
  "Central Harbour",
  "Port Moody Arm")

Fjords <- c(
  "Rivers Inlet",
  "Bute Inlet",
  "Toba Inlet",
  "Howe Sound",
  "Indian Arm"
)
```




```{r}

plotNMDS <- function(month, location, norm) {

  tmp <- Indexed_UO_12S %>% 
    mutate(Environment = ifelse(Location %in% Fjords, "Fjords", "Urban"))


  if (norm == "eDNA-index") {
    wide <- tmp %>%
      filter(Month %in% month,
             Location %in% location) %>%
      select(Sample_ID, Month, Location, Environment, RA_Index, Name) %>%
      pivot_wider(names_from = Name, values_from = RA_Index)
  } else {
    wide <- tmp %>%
      filter(Month %in% month,
             Location %in% location) %>%
      select(Sample_ID, Month, Location, Environment, RA, Name) %>%
      pivot_wider(names_from = Name, values_from = RA)
  }

# Extract Matrix
mat <- wide %>%
    select(!2:4) %>% 
    column_to_rownames("Sample_ID") %>% 
    as.matrix()

# Run NMDS
mod <- metaMDS(mat, trymax = 100, trace = FALSE)

# NEW
Species_scores <- 
  scores(mod)$species %>% 
  as.data.frame() %>%
  rownames_to_column("Species")

# SIMPER
simper_result <- simper(mat, group = wide$Environment) %>% 
  summary()

Simper_tab <- simper_resul[1] %>%
  rownames_to_column("Species")

Top_Species <- Simper_tab %>% 
  filter(average > 0.01) %>% 
  pull(Species)
  

# Extract Scores back to matrix
Sample_scores <-
    scores(mod)$sites %>% 
    as.data.frame() %>%
    rownames_to_column("Sample_ID") %>% 
    left_join(select(wide, 1:4), by = "Sample_ID")


NMDS_plot <- Sample_scores %>% 
  ggplot() +
  geom_point(mapping = aes(NMDS1, NMDS2, colour = Location),
             size = 3) +
  stat_ellipse(aes(NMDS1, NMDS2, linetype = Environment), level = 0.95) +
  geom_text(data = filter(Species_scores, Species %in% Top_Species),
            mapping = aes(NMDS1, NMDS2, label = Species)) +
  theme_minimal_grid(12) +
  theme(aspect.ratio = 1,
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_color_manual(values = Location_color)


Permanova_tab <- adonis2(mat ~ Location+Month,
                       data = wide,
                       permutations = 999, method="bray") %>% 
  tidy()

list(NMDS_plot,
     Permanova_tab,
     Simper_tab,
     Sample_scores,
     Species_scores,
     Data = wide)

}





```



```{r}

printPERMANOVA <- function(month, location, norm) {

  if (norm == "eDNA-index") {
    wide <- Indexed_UO_12S %>%
      filter(Month %in% month,
             Location %in% location) %>%
      select(Sample_ID, Month, Location, RA_Index, Name) %>%
      pivot_wider(names_from = Name, values_from = RA_Index)
  } else {
    wide <- Indexed_UO_12S %>%
      filter(Month %in% month,
             Location %in% location) %>%
      select(Sample_ID, Month, Location, RA, Name) %>%
      pivot_wider(names_from = Name, values_from = RA)
  }

# Extract Matrix
mat <- wide %>%
    select(!2:3) %>% 
    column_to_rownames("Sample_ID") %>% 
    as.matrix()


adonis2(mat ~ Location,
                       data = wide,
                       permutations = 999, method="bray") %>% 
  tidy()
}
```





```{r}
plotNMDS <- function(month, location, norm) {

  tmp <- Indexed_UO_12S %>% 
    mutate(Environment = ifelse(Location %in% Fjords, "Fjords", "Urban"))


  if (norm == "eDNA-index") {
    wide <- tmp %>%
      filter(Month %in% month,
             Location %in% location) %>%
      select(Sample_ID, Month, Location, Environment, RA_Index, Name) %>%
      pivot_wider(names_from = Name, values_from = RA_Index)
  } else {
    wide <- tmp %>%
      filter(Month %in% month,
             Location %in% location) %>%
      select(Sample_ID, Month, Location, Environment, RA, Name) %>%
      pivot_wider(names_from = Name, values_from = RA)
  }

# Extract Matrix
mat <- wide %>%
    select(!2:4) %>% 
    column_to_rownames("Sample_ID") %>% 
    as.matrix()

# Run NMDS
mod <- metaMDS(mat, trymax = 100, trace = FALSE)

# NEW
Species_scores <- 
  scores(mod)$species %>% 
  as.data.frame() %>%
  rownames_to_column("Species")

# SIMPER
simper_result <- simper(mat, group = wide$Environment) %>% 
  summary()

Simper_tab <- simper_resul[1] %>%
  rownames_to_column("Species")

Top_Species <- Simper_tab %>% 
  filter(average > 0.01) %>% 
  pull(Species)
  

# Extract Scores back to matrix
Sample_scores <-
    scores(mod)$sites %>% 
    as.data.frame() %>%
    rownames_to_column("Sample_ID") %>% 
    left_join(select(wide, 1:4), by = "Sample_ID")


NMDS_plot <- Sample_scores %>% 
  ggplot() +
  geom_point(mapping = aes(NMDS1, NMDS2, colour = Location),
             size = 3) +
  stat_ellipse(aes(NMDS1, NMDS2, linetype = Environment), level = 0.95) +
  geom_text(data = filter(Species_scores, Species %in% Top_Species),
            mapping = aes(NMDS1, NMDS2, label = Species)) +
  theme_minimal_grid(12) +
  theme(aspect.ratio = 1,
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_color_manual(values = Location_color)


Permanova_tab <- adonis2(mat ~ Location+Month,
                       data = wide,
                       permutations = 999, method="bray") %>% 
  tidy()

list(NMDS_plot,
     Permanova_tab,
     Simper_tab,
     Sample_scores,
     Species_scores,
     Data = wide)

}

```



```{r}
All <- plotNMDS(Months, Locations, "eDNA-index")

Months
```


```{r}



All

Feb <- plotNMDS("Feb/Mar", Locations, "Relative Abundance")
May <- plotNMDS("May", Locations, "Relative Abundance")
Aug <- plotNMDS("Aug", Locations, "Relative Abundance")
Nov <- plotNMDS("Nov", Locations, "Relative Abundance")

ggarrange(Feb, May, Aug, Nov, labels = "AUTO", common.legend = TRUE)


Feb <- plotNMDS("Feb/Mar", Locations, "eDNA-index")
May <- plotNMDS("May", Locations, "eDNA-index")
Aug <- plotNMDS("Aug", Locations, "eDNA-index")
Nov <- plotNMDS("Nov", Locations, "eDNA-index")


ggarrange(Feb, May, Aug, Nov, labels = "AUTO", common.legend = TRUE)

Feb



all <- plotNMDS(Months, Locations, "eDNA-index")


mat <- all$Data %>% 
    select(!2:4) %>% 
    column_to_rownames("Sample_ID") %>% 
    as.matrix()

ind_mod <- multipatt(mat, all$Data$Environment, func = "IndVal.g")
summary(ind_mod)
ind_mod




```

