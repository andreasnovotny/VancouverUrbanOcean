---
title: "Vancouver Urban Ocean eDNA"
output: 
  flexdashboard::flex_dashboard:
    social: menu
    source_code: embed
    orientation: columns
    vertical_layout: fill
    theme: simplex
runtime: shiny
---

```{r}

# Specific plotting tools
library(plotly)
library(ggpubr)
library(paletteer)
library(viridis)
library(cowplot)
library(leaflet)
library(readxl)
library(tidyverse)
source("Code/Functions.R")
```



```{r}
# Sequencing data
ASV_12S <- read_csv("Data_import/MiFish-U_species_table.csv")  %>% 
  filter(Group != "Total") %>%  select(!Total)

# Sample metadata
VeDNA_UrbanOcean2023_sampledata <- read_excel("Data_import/VeDNA_UrbanOcean2023_sampledata.xlsx", 
    col_types = c("text", "text", "text", 
        "date", "text", "text", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "numeric", 
        "date", "text", "date", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "numeric", "text", "text", 
        "text"))

# Sequencing pool metadata
Sequencing_Pool_12S_VeDNA2023 <- read_excel("Data_import/Sequencing_Pool_12S-VeDNA2023.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "numeric", "text", "numeric", 
        "numeric", "numeric", "numeric")) %>% 
  filter(Pool_ID == "12S-VeDNA2023")

# Merge sample and library metadata
Sample_Data_12S <- VeDNA_UrbanOcean2023_sampledata %>% 
  right_join(Sequencing_Pool_12S_VeDNA2023, by = "Sample_ID") %>% 
  select(Library_ID, 1:15, 18, Library_Concentration, Volume_added) %>% 
  mutate(Type = ifelse(is.na(Type), "PCRBlank", Type))

# Merge metadata with sequencing data
OU_12S <- ASV_12S %>% 
  pivot_longer(!1:4, names_to = "Library_ID", values_to = "Abundance") %>% 
  left_join(Sample_Data_12S, by = "Library_ID") %>% 
  filter(is.na(Type) == FALSE)

Good_OU_12S <- OU_12S %>% 
  group_by(Library_ID) %>%
  filter(sum(Abundance)>10000) %>% 
  ungroup()

OU_12S_Index <- Good_OU_12S %>% 
  index_RA(sample = Library_ID,
           taxa = TaxonName,
           abundance = Abundance,
           Sample_Date, Station_ID, Location, Line_out_depth,
           Bottom_depth, Latitude, Longitude)


Rank <- OU_12S_Index %>% 
  group_by(TaxonName) %>% 
  summarise(RA = mean(RA)) %>% 
  arrange(-RA) %>% 
  filter(RA > 0.0005)

OU_12S_Index <- OU_12S_Index %>% 
  filter(TaxonName %in% Rank$TaxonName)


common_names <- read_excel("Data_output/Common_names.xlsx")


all_species <- OU_12S_Index %>% 
  pull(TaxonName) %>%  unique()

```


Explore Data
=======================================================================
```{r}
OU_12S_Index
```


```{r}

# 1. Map function
plotMat <- function(taxa, month) {
  
  m = OU_12S_Index %>% 
  group_by(TaxonName, Sample_Date, Station_ID, Latitude, Longitude) %>% 
  summarise(RA_Index = mean(RA_Index),
            RA = mean(RA),
            Seq.abundance = sum(Abundance)) %>%
  mutate(Month = month(Sample_Date)) %>%
  mutate(Popup = paste(Station_ID, "<br/>",
                       "eDNA Index: ", round(RA_Index, digits = 3), "<br/>",
                       "Relative Abundance: ", round(RA, digits = 3), "<br/>",
                       "Number of sequences: ", Seq.abundance)) %>% 
  
  filter(TaxonName == taxa,
         Month == month) %>% 
  leaflet() %>%
  addTiles() %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>%
  setView(-123.1, 49.30, zoom = 11) %>% 
  addCircles(~Longitude, ~Latitude, popup = ~Popup,
             weight = ~RA_Index*75, color = "red")
  return(m)

}


```







Inputs {.sidebar}
-----------------------------------------------------------------------

##### Select Species

```{r}
selectInput(
  "Filt_Taxa",
  NULL,
  choices = all_species,
  selected = "Salmon, Chum"
)
```


**Please consider:**

- This app is still being developed, and the data has not been verified.
- Red circles represent eDNA index, normalized relative abundance. This can be used to infer differences in proportion between sites and seasons, but it does not say anything about the absolute biomass.
- Also species with extremely low biomass will appear with at least one big red circle.
- The more observations of one species (number of red circles), the more reliable is the data.




##### About

Built buy **Andreas Novotny**

**Contact:** a.novotny@oceans.ubc.ca


Column
-----------------------------------------------------------------------

### March 
```{r}

renderLeaflet({
  plotMat(input$Filt_Taxa, 3)
})
```


### May 

```{r}

renderLeaflet({
  plotMat(input$Filt_Taxa, 5)
})
```


Column
-----------------------------------------------------------------------

### August 
```{r}

renderLeaflet({
  plotMat(input$Filt_Taxa, 8)
})
```


### November 

```{r}

renderLeaflet({
  plotMat(input$Filt_Taxa, 11)
})
```

Community analysis
=======================================================================

Inputs {.sidebar}
-----------------------------------------------------------------------


**Relative eDNA Abundance** of taxa identified with 12S eDNA. It is likely that taxa with higher relative abundance are also more abundant in the ecosystem, however this relationship is very week, and are biased by several methodological aspects.

However, higher relative abundance generally means that the data is more reliable.


Column
-----------------------------------------------------------------------

```{r}

```



##### About

Built buy **Andreas Novotny**

**Contact:** a.novotny@oceans.ubc.ca

Diagnostic
=======================================================================

Inputs {.sidebar}
-----------------------------------------------------------------------


**Relative eDNA Abundance** of taxa identified with 12S eDNA. It is likely that taxa with higher relative abundance are also more abundant in the ecosystem, however this relationship is very week, and are biased by several methodological aspects.

However, higher relative abundance generally means that the data is more reliable.


##### About

Built buy **Andreas Novotny**

**Contact:** a.novotny@oceans.ubc.ca








Column {.tabset}
-------------------------------------
### Relative abundance



```{r}
OU_12S_Index %>%
  filter(Abundance > 0) %>%
  group_by(Taxa) %>% 
  mutate(maxRA = median(RA)) %>%
  ungroup() %>% 
  mutate(Taxa = fct_reorder(Taxa, -maxRA)) %>% 
  ggplot() +
  geom_boxplot(aes(Taxa, RA)) +
  theme_minimal_hgrid(font_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,
                                   face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey')) +
  scale_y_continuous(trans='log10')
```




### All stations


```{r}
OU_12S_Index %>% 
  group_by(Date, Station_ID, Long, Lat) %>% 
  summarise() %>%
  leaflet() %>%
  addTiles() %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>%
  setView(-123.1, 49.30, zoom = 11) %>% 
  addMarkers(~Long, ~Lat, label = ~Station_ID)
```



About
=======================================================================

Samples collected during March-November 2023, by the **University of British Columbia** in collaboration with **Tsleil-Waututh First Nation**.

Each sample represents ~2L of filtered water. 12S amplified using MiFish-U, sequenced on Illumina MiSeq, and assigned towards a custom database. 


Built buy **Andreas Novotny**

**Contact:** a.novotny@oceans.ubc.ca
